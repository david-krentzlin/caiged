#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
Usage: caiged <working-dir> [options] [-- <command>]

Options:
  --task <name>          Spin name (default: qa)
  --project <name>       Project name for container naming
  --enable-network       Enable network access (default: disabled)
  --disable-docker-sock  Do not mount /var/run/docker.sock
  --mount-gh             Mount host gh config (default: enabled if present)
  --mount-gh-rw          Mount host gh config read-write
  --no-mount-gh          Do not mount host gh config
  --force-build          Rebuild base and spin images
  --detach               Run container in background and do not attach (default attaches)
  --attach               Attach to existing container shell
  --list                 List active caiged containers and tmux sessions
  -h, --help             Show this help
EOF
}

SPIN="qa"
PROJECT_NAME=""
ENABLE_NETWORK=0
ENABLE_DOCKER_SOCK=1
FORCE_BUILD=0
DETACH=1
ATTACH=0
ATTACH_ON_START=1
MOUNT_GH=1
MOUNT_GH_RW=0
LIST=0
WORKDIR=""
COMMAND_ARGS=()

while [ "$#" -gt 0 ]; do
  case "$1" in
    --task)
      SPIN="$2"
      shift 2
      ;;
    --project)
      PROJECT_NAME="$2"
      shift 2
      ;;
    --enable-network)
      ENABLE_NETWORK=1
      shift
      ;;
    --disable-docker-sock)
      ENABLE_DOCKER_SOCK=0
      shift
      ;;
    --mount-gh)
      MOUNT_GH=1
      shift
      ;;
    --mount-gh-rw)
      MOUNT_GH=1
      MOUNT_GH_RW=1
      shift
      ;;
    --no-mount-gh)
      MOUNT_GH=0
      shift
      ;;
    --force-build)
      FORCE_BUILD=1
      shift
      ;;
    --detach)
      DETACH=1
      ATTACH_ON_START=0
      shift
      ;;
    --attach)
      ATTACH=1
      shift
      ;;
    --list)
      LIST=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    --)
      shift
      COMMAND_ARGS+=("$@")
      break
      ;;
    -* )
      echo "Unknown option: $1" >&2
      usage
      exit 1
      ;;
    *)
      if [ -z "$WORKDIR" ]; then
        WORKDIR="$1"
        shift
      else
        COMMAND_ARGS+=("$1")
        shift
      fi
      ;;
  esac
done

IMAGE_PREFIX="${IMAGE_PREFIX:-caiged}"

if [ "$LIST" -eq 1 ]; then
  echo "Running containers:"
  docker ps --filter "name=^/${IMAGE_PREFIX}-" --format "{{.Names}}\t{{.Status}}" || true
  echo
  echo "All containers:"
  docker ps -a --filter "name=^/${IMAGE_PREFIX}-" --format "{{.Names}}\t{{.Status}}" || true
  echo
  if command -v tmux >/dev/null 2>&1; then
    echo "Tmux sessions:"
    tmux list-sessions -F "#{session_name}" 2>/dev/null | grep "^${IMAGE_PREFIX}-" || true
  else
    echo "Tmux sessions: tmux not available"
  fi
  exit 0
fi

if [ -z "$WORKDIR" ]; then
  echo "Missing working directory." >&2
  usage
  exit 1
fi

if [ ! -d "$WORKDIR" ]; then
  echo "Working directory does not exist: $WORKDIR" >&2
  exit 1
fi

WORKDIR_ABS="$(cd "$WORKDIR" && pwd)"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

SPIN_DIR="${REPO_ROOT}/spins/${SPIN}"
if [ ! -d "$SPIN_DIR" ]; then
  echo "Unknown spin: $SPIN (missing $SPIN_DIR)" >&2
  exit 1
fi

BASE_IMAGE="${IMAGE_PREFIX}:base"
SPIN_IMAGE="${IMAGE_PREFIX}:${SPIN}"

if [ -z "$PROJECT_NAME" ]; then
  IFS='/' read -r -a path_parts <<< "$WORKDIR_ABS"
  filtered_parts=()
  for part in "${path_parts[@]}"; do
    if [ -n "$part" ]; then
      filtered_parts+=("$part")
    fi
  done
  part_count="${#filtered_parts[@]}"
  if [ "$part_count" -ge 2 ]; then
    PROJECT_NAME="${filtered_parts[$((part_count - 2))]}-${filtered_parts[$((part_count - 1))]}"
  elif [ "$part_count" -eq 1 ]; then
    PROJECT_NAME="${filtered_parts[0]}"
  else
    PROJECT_NAME="workspace"
  fi
fi

PROJECT_SLUG="${PROJECT_NAME,,}"
PROJECT_SLUG="${PROJECT_SLUG// /-}"
PROJECT_CLEAN=""
for ((i=0; i<${#PROJECT_SLUG}; i++)); do
  char="${PROJECT_SLUG:i:1}"
  case "$char" in
    [a-z0-9_.-]) PROJECT_CLEAN+="$char" ;;
    *) PROJECT_CLEAN+="-" ;;
  esac
done

while [ -n "$PROJECT_CLEAN" ]; do
  case "${PROJECT_CLEAN:0:1}" in
    [a-z0-9]) break ;;
    *) PROJECT_CLEAN="${PROJECT_CLEAN:1}" ;;
  esac
done

while [ -n "$PROJECT_CLEAN" ]; do
  case "${PROJECT_CLEAN: -1}" in
    [a-z0-9]) break ;;
    *) PROJECT_CLEAN="${PROJECT_CLEAN%?}" ;;
  esac
done

if [ -z "$PROJECT_CLEAN" ]; then
  PROJECT_CLEAN="workspace"
fi

CONTAINER_NAME="${IMAGE_PREFIX}-${SPIN}-${PROJECT_CLEAN}"
SESSION_NAME="${CONTAINER_NAME}"
CONTAINER_SHELL="${CONTAINER_SHELL:-/bin/zsh}"

if [ "$ATTACH" -eq 1 ]; then
  ATTACH_ON_START=1
fi

GH_HOST_CONFIG="${HOME}/.config/gh"
GH_MOUNT=()
if [ "$MOUNT_GH" -eq 1 ] && [ -d "$GH_HOST_CONFIG" ]; then
  if [ "$MOUNT_GH_RW" -eq 1 ]; then
    GH_MOUNT=(-v "$GH_HOST_CONFIG:/root/.config/gh")
  else
    GH_MOUNT=(-v "$GH_HOST_CONFIG:/root/.config/gh:ro")
  fi
fi

ARCH="${ARCH:-arm64}"
MISE_VERSION="${MISE_VERSION:-2026.2.13}"
GH_VERSION="${GH_VERSION:-2.86.0}"
OP_VERSION="${OP_VERSION:-2.32.1}"
OPENCODE_VERSION="${OPENCODE_VERSION:-latest}"

build_base() {
  docker build --target base \
    -t "$BASE_IMAGE" \
    --build-arg ARCH="$ARCH" \
    --build-arg MISE_VERSION="$MISE_VERSION" \
    --build-arg GH_VERSION="$GH_VERSION" \
    --build-arg OP_VERSION="$OP_VERSION" \
    --build-arg OPENCODE_VERSION="$OPENCODE_VERSION" \
    "$REPO_ROOT"
}

build_spin() {
  docker build --target spin \
    -t "$SPIN_IMAGE" \
    --build-arg ARCH="$ARCH" \
    --build-arg MISE_VERSION="$MISE_VERSION" \
    --build-arg GH_VERSION="$GH_VERSION" \
    --build-arg OP_VERSION="$OP_VERSION" \
    --build-arg OPENCODE_VERSION="$OPENCODE_VERSION" \
    --build-arg SPIN="$SPIN" \
    "$REPO_ROOT"
}

if [ "$FORCE_BUILD" -eq 1 ]; then
  build_base
  build_spin
else
  if ! docker image inspect "$BASE_IMAGE" >/dev/null 2>&1; then
    build_base
  fi
  if ! docker image inspect "$SPIN_IMAGE" >/dev/null 2>&1; then
    build_spin
  fi
fi

container_exists() {
  docker inspect "$CONTAINER_NAME" >/dev/null 2>&1
}

container_running() {
  docker inspect -f '{{.State.Running}}' "$CONTAINER_NAME" 2>/dev/null | grep -q true
}

start_container_detached() {
  if container_running; then
    return
  fi
  if container_exists; then
    docker rm -f "$CONTAINER_NAME" >/dev/null 2>&1 || true
  fi

  RUN_ARGS=(-d --rm --name "$CONTAINER_NAME" -v "$WORKDIR_ABS:/workspace")
  if [ "$ENABLE_NETWORK" -eq 0 ]; then
    RUN_ARGS+=(--network=none)
  fi
  if [ "$ENABLE_DOCKER_SOCK" -eq 1 ]; then
    RUN_ARGS+=(-v /var/run/docker.sock:/var/run/docker.sock)
  fi
  if [ "${#GH_MOUNT[@]}" -gt 0 ]; then
    RUN_ARGS+=("${GH_MOUNT[@]}")
  fi
  RUN_ARGS+=(-e AGENT_SPIN="$SPIN" -e AGENT_DAEMON=1)
  docker run "${RUN_ARGS[@]}" "$SPIN_IMAGE"
}

ensure_tmux_session() {
  if ! command -v tmux >/dev/null 2>&1; then
    return 1
  fi

  if tmux has-session -t "$SESSION_NAME" >/dev/null 2>&1; then
    return 0
  fi

  tmux new-session -d -s "$SESSION_NAME" -n shell "docker exec -it $CONTAINER_NAME $CONTAINER_SHELL"
}

attach_shell() {
  if ensure_tmux_session; then
    if [ -n "${TMUX:-}" ]; then
      exec tmux switch-client -t "$SESSION_NAME"
    fi
    exec tmux attach -t "$SESSION_NAME"
  fi

  exec docker exec -it "$CONTAINER_NAME" "$CONTAINER_SHELL"
}

if [ "${#COMMAND_ARGS[@]}" -gt 0 ]; then
  RUN_ARGS=(--rm -it --name "$CONTAINER_NAME" -v "$WORKDIR_ABS:/workspace")
  if [ "$ENABLE_NETWORK" -eq 0 ]; then
    RUN_ARGS+=(--network=none)
  fi
  if [ "$ENABLE_DOCKER_SOCK" -eq 1 ]; then
    RUN_ARGS+=(-v /var/run/docker.sock:/var/run/docker.sock)
  fi
  if [ "${#GH_MOUNT[@]}" -gt 0 ]; then
    RUN_ARGS+=("${GH_MOUNT[@]}")
  fi
  RUN_ARGS+=(-e AGENT_SPIN="$SPIN")
  docker run "${RUN_ARGS[@]}" "$SPIN_IMAGE" "${COMMAND_ARGS[@]}"
  exit 0
fi

start_container_detached

if [ "$DETACH" -eq 1 ] && [ "$ATTACH_ON_START" -eq 0 ]; then
  exit 0
fi

attach_shell
